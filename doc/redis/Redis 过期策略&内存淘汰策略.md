Redis 过期策略&内存淘汰策略
===

## 内存过期策略

内存过期策略的主要目的是在缓存过期之后，能够及时地将失效的内存从内存中删除，以减少内存的无效占用，达到释放内存的目的。


### 过期策略的分类

* 定时策略。
* 惰性策略。
* 定期策略。

### 定时策略

含义：在设置 key 的过期时间的同时，为该 key 创建一个定时器，让定时器在 key 的过期时间来临的时候将 key 删除。

优点：保证内存被尽快释放，减少无效的缓存占用。

缺点：若使用过多的定时器对每个 key 进行监控的话，必然会占用大量的 CPU。

### 惰性策略

含义：key 过期的时候并不会马上被删除，只有当获取 key 的时候才会去检查是否过期。

优点：并不需要额外的 CPU 时间来监控过期 key，

缺点：若大量的过期 key 在很长时间内都没有再被调用，那么就有可能发生内存泄漏。

### 定期策略

含义：每隔一段时间对设置了缓存的 key 进行检测，如果已经失效，则从内存中进行删除，如果未失效，则不作任何处理。

优点：通过限制删除操作的时长和频率，来减少删除操作对 CPU的占用，同时也可以对部分过期 key 进行处理。

难点在于合理设置删除操作的执行时长(每次删除执行多长时间)和执行频率(每隔多长时间做一次删除)，需要根据服务器运行情况和实际需求来决定。


## 内存淘汰策略

内存淘汰机制是 Redis 针对内存不足的情况下的一种处理机制。当 Redis 存储已经超过了内存限制，但是还在继续追加缓存内容，就会触发内存淘汰策略。

### Redis 常见的六种淘汰策略

* noeviction：不删除策略，达到最大内存限制时，如果需要更多内存，直接返回错误信息。
* allkeys-lru：所有 key 通用，优先删除最近最少使用(less recently used, LRU) 的 key。
* volatile-lru：只限于设置了 expire 的部分 key，优先删除最近最少使用(less recently used, LRU) 的 key。
* allkeys-random：所有 key 通用，随机删除一部分 key。
* volatile-random：只限于设置了 expire 的部分 key，随机删除一部分 key。
* volatile-ttl: 只限于设置了 expire 的部分; 优先删除剩余时间(time to live，TTL) 短的key

### 设置方法
```
// 常用是设置为 allkeys-lru
maxmemory-policy allkeys-lru
```

### 使用场景

1. 如果分为冷热数据，那么可以使用 allkeys-lru 策略。
2. 如果需要循环读写所有的 key，或者每个 key 的访问策略都差不多，可以使用 allkeys-random 策略。
3. 假如要让 Redis 根据 ttl 来筛选淘汰的 key，可以使用 volatile-ttl 策略。


